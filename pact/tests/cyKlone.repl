(load "../kadena_repl_sandbox/kda-env/init.repl")

;; Define the governance keyset
(begin-tx)
(namespace 'free)
(env-data {'ks:["governance-key"]})
(env-keys ["governance-key"] )
(define-keyset "free.cyKlone-test-ks" (read-keyset 'ks))
(commit-tx)

;; Load Poseidon contracts
(begin-tx)
(namespace 'free)
(load "../pact-zk-hashes/pact/contracts/poseidon-constants.pact")
(load "../pact-zk-hashes/pact/contracts/poseidon.pact")
(commit-tx)

;; Load cyKlone
(begin-tx)
(env-keys ["governance-key"] )
(namespace 'free)
(load "../contracts/cyklone-withdraw-verifier-v0.pact")
(load "../contracts/cyklone.pact")
(create-table global-state)
(create-table nullifiers)
(create-table deposits)
(init)
(coin.create-account WORK-GAS-STATION basic-guards.GUARD_SUCCESS)
(commit-tx)

; Load test vectors in the root namespace
(begin-tx)
(load "test-vectors.pact")
(commit-tx)

; Load an util module no make n-work
(begin-tx)
(module cyKlone-utils G
  (defcap G() true)
  (defun repeat-N-work (n:integer)
    (let ((_work (lambda (_) (free.cyKlone-v0-10.work))))
      (map (_work) (enumerate 1 n))))
)
(commit-tx)

; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
;;; First Alice Deposit
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
; Verify the balance before
(expect "Balance before deposit" 1000.0 (coin.get-balance "alice"))

;Do the deposit
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE DENOMINATION)]}])
(deposit "alice" DEPOSIT_0)

; Try to deposit 2 times
(expect-failure "Can't deposit 2 times with the same commitment" "already submitted" (deposit "alice" DEPOSIT_0))

; Verify the balance after
(expect "Balance before deposit" 990.0 (coin.get-balance "alice"))
(commit-tx)

; Try to withdraw
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)

; Verify the balance of Bob before
(expect "Balance before withdraw" 1000.0 (coin.get-balance "bob"))
(expect-failure "Must not work => Deposit not processed" "root unknown" (withdraw "bob" WITHDRAW_0_0_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_0_PROOF))

(expect-that "Deposit count must have been incremented" (compose (at 'deposit-count) (= 1)) (get-state))

; Process te deposit
(repeat-N-work 6)
(expect-that "Deposit rank must have been incremented" (compose (at 'current-rank) (= 1)) (get-state))

; There is no work anymore
(expect-failure "No work anymore" "work" (work))

; And retry to withdraw
; But first with a bad proof
(expect-failure "Must not work => Bad paramaters" "does not match" (withdraw "bob" WITHDRAW_0_0_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_1_PROOF))
; A bad root
(expect-failure "Must not work => Bad paramaters" "unknown" (withdraw "bob" WITHDRAW_0_0_NULL WITHDRAW_0_1_ROOT WITHDRAW_0_0_PROOF))
; And a bad nullifier
(expect-failure "Must not work => Bad paramaters" "does not match" (withdraw "bob" WITHDRAW_1_1_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_0_PROOF))
; And a bad account
(expect-failure "Must not work => Bad paramaters" "does not match" (withdraw "carol" WITHDRAW_0_0_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_0_PROOF))


; And finally with everything OK
(withdraw "bob" WITHDRAW_0_0_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_0_PROOF)
(expect-that "Balance after withdraw" (< 1009.0) (coin.get-balance "bob"))

; Try to withdraw again
(expect-failure "Double withdraw is porhibited" "already withdrawn" (withdraw "bob" WITHDRAW_0_0_NULL WITHDRAW_0_0_ROOT WITHDRAW_0_0_PROOF))
(commit-tx)

; Check another time to deposit the same commitment
; Because here the commitment is not in queue anymore but should however fail
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE DENOMINATION)]}])
; Try to deposit 2 times
(expect-failure "Can't deposit 2 times with the same commitment" "already submitted" (deposit "alice" DEPOSIT_0))
(commit-tx)


; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; Deposits 3 times in a row
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
; Verify the balance before
(expect "Balance before deposit" 990.0 (coin.get-balance "alice"))
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE DENOMINATION)]}])
(deposit "alice" DEPOSIT_1)

; Verify the balance after
(expect "Balance before deposit" 980.0 (coin.get-balance "alice"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
; Verify the balance before
(expect "Balance before deposit" 980.0 (coin.get-balance "alice"))
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE DENOMINATION)]}])
(deposit "alice" DEPOSIT_2)

; Verify the balance after
(expect "Balance before deposit" 970.0 (coin.get-balance "alice"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
; Verify the balance before
(expect "Balance before deposit" 970.0 (coin.get-balance "alice"))
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE DENOMINATION)]}])
(deposit "alice" DEPOSIT_3)

; Verify the balance after
(expect "Balance before deposit" 960.0 (coin.get-balance "alice"))
(commit-tx)


; Now Process the deposits
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)

(expect-that "Deposit count must have been incremented to 4" (compose (at 'deposit-count) (= 4)) (get-state))
; Process te deposit
(repeat-N-work 18)

(expect-that "Deposit rank must have been incremented" (compose (at 'current-rank) (= 4)) (get-state))

; There is no work anymore
(expect-failure "No work anymore" "work" (work))
(commit-tx)

; And withdraw in various order using various roots
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_3_3_NULL WITHDRAW_3_3_ROOT WITHDRAW_3_3_PROOF)
(expect-that "Balance after withdraw" (< 1019.0) (coin.get-balance "bob"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_2_3_NULL WITHDRAW_2_3_ROOT WITHDRAW_2_3_PROOF)
(expect-that "Balance after withdraw" (< 1029.0) (coin.get-balance "bob"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_1_3_NULL WITHDRAW_1_3_ROOT WITHDRAW_1_3_PROOF)
(expect-that "Balance after withdraw" (< 1039.0) (coin.get-balance "bob"))
(commit-tx)


; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; Deposits now 16 times in a row
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
; Verify the balance before
(expect "Balance before deposit" 960.0 (coin.get-balance "alice"))
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE (* 16 DENOMINATION))]}])
(deposit "alice" DEPOSIT_4)
(deposit "alice" DEPOSIT_5)
(deposit "alice" DEPOSIT_6)
(deposit "alice" DEPOSIT_7)
(deposit "alice" DEPOSIT_8)
(deposit "alice" DEPOSIT_9)
(deposit "alice" DEPOSIT_10)
(deposit "alice" DEPOSIT_11)
(deposit "alice" DEPOSIT_12)
(deposit "alice" DEPOSIT_13)
(deposit "alice" DEPOSIT_14)
(deposit "alice" DEPOSIT_15)
(deposit "alice" DEPOSIT_16)
(deposit "alice" DEPOSIT_17)
(deposit "alice" DEPOSIT_18)
(deposit "alice" DEPOSIT_19)

(repeat-N-work (* 16 6))

; Verify the balance after
(expect "Balance after deposit" 800.0 (coin.get-balance "alice"))
(commit-tx)

; Do some withdrawn
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_10_10_NULL WITHDRAW_10_10_ROOT WITHDRAW_10_10_PROOF)
(expect-that "Balance after withdraw" (< 1049.0) (coin.get-balance "bob"))
; We rollback to try to withdraw with another root as well
(rollback-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_10_18_NULL WITHDRAW_10_18_ROOT WITHDRAW_10_18_PROOF)
(expect-that "Balance after withdraw" (< 1049.0) (coin.get-balance "bob"))
(commit-tx)


(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(withdraw "bob" WITHDRAW_19_19_NULL WITHDRAW_19_19_ROOT WITHDRAW_19_19_PROOF)
(expect-that "Balance after withdraw" (< 1059.0) (coin.get-balance "bob"))
(commit-tx)



; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; ------------------------------------------------------------------------------
; Now we are filling several levels of the tree until rank 65 and checks that everything is fine
; This test as well the filling of the known-root hist
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
; Verify the balance before
(expect "Balance before deposit" 800.0 (coin.get-balance "alice"))
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE (* 22 DENOMINATION))]}])
(deposit "alice" DEPOSIT_20)
(deposit "alice" DEPOSIT_21)
(deposit "alice" DEPOSIT_22)
(deposit "alice" DEPOSIT_23)
(deposit "alice" DEPOSIT_24)
(deposit "alice" DEPOSIT_25)
(deposit "alice" DEPOSIT_26)
(deposit "alice" DEPOSIT_27)
(deposit "alice" DEPOSIT_28)
(deposit "alice" DEPOSIT_29)

(deposit "alice" DEPOSIT_30)
(deposit "alice" DEPOSIT_31)
(deposit "alice" DEPOSIT_32)
(deposit "alice" DEPOSIT_33)
(deposit "alice" DEPOSIT_34)
(deposit "alice" DEPOSIT_35)
(deposit "alice" DEPOSIT_36)
(deposit "alice" DEPOSIT_37)
(deposit "alice" DEPOSIT_38)
(deposit "alice" DEPOSIT_39)

(deposit "alice" DEPOSIT_40)
(deposit "alice" DEPOSIT_41)

(expect "Balance after deposit" 580.0 (coin.get-balance "alice"))

(repeat-N-work (* 11 6))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(use cyKlone-utils)
(repeat-N-work (* 11 6))
(expect-failure "No work anymore" "work" (work))
(expect-that "Deposit count and rank must have been incremented to 42" (and? (compose (at 'deposit-count) (= 42))
                                                                             (compose (at 'current-rank) (= 42))) (get-state))
(commit-tx)

; Do some withdrawals now
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)

; Withdrawl from an old root shoudn't work
(expect-failure "The root is too old" "root unknown" (withdraw "bob" WITHDRAW_4_4_NULL WITHDRAW_4_4_ROOT WITHDRAW_4_4_PROOF))
; But with a more recent root => Shoudl work
(withdraw "bob" WITHDRAW_4_40_NULL WITHDRAW_4_40_ROOT WITHDRAW_4_40_PROOF)
(expect-that "Balance after withdraw" (< 1069.0) (coin.get-balance "bob"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(withdraw "bob" WITHDRAW_40_40_NULL WITHDRAW_40_40_ROOT WITHDRAW_40_40_PROOF)
(expect-that "Balance after withdraw" (< 1079.0) (coin.get-balance "bob"))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(withdraw "bob" WITHDRAW_41_41_NULL WITHDRAW_41_41_ROOT WITHDRAW_41_41_PROOF)
(expect-that "Balance after withdraw" (< 1089.0) (coin.get-balance "bob"))
(commit-tx)

;;;;;  ---------------------------- LOCAL FUNCTIONS TEST ----------------------
(begin-tx)
(use free.cyKlone-v0-10)
(use test-vectors)
(expect "Deposit rank is OK" 10 (get-deposit-rank DEPOSIT_10))
(expect "Commitment not deposited => -1" -1 (get-deposit-rank DEPOSIT_45))

(expect "Nullifier state of an already withdrawn => True" true (get-nullifier-state WITHDRAW_41_41_NULL))
(expect "Nullifier state of not withdrawn => False" false (get-nullifier-state WITHDRAW_36_36_NULL))

(expect "Check a deposit range" [DEPOSIT_12, DEPOSIT_13, DEPOSIT_14, DEPOSIT_15] (get-deposits-range 12 15))
(expect "Check a deposit range" [DEPOSIT_39, DEPOSIT_40, DEPOSIT_41] (get-deposits-range 39 45))
