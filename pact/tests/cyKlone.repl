(load "../kadena_repl_sandbox/kda-env/init.repl")

(begin-tx)
(namespace 'free)
(load "../pact-zk-hashes/pact/contracts/poseidon-constants.pact")
(load "../pact-zk-hashes/pact/contracts/poseidon.pact")
(commit-tx)

(begin-tx)
(namespace 'free)
(env-data {'ks:["governance-key"]})
(env-keys ["governance-key"] )
(define-keyset "free.cyKlone-test-ks" (read-keyset 'ks))
(commit-tx)


(begin-tx)
(env-keys ["governance-key"] )
(namespace 'free)
(load "../contracts/cyklone-withdraw-verifier-v0.pact")
(load "../contracts/cyklone.pact")
(create-table global-state)
(create-table nullifiers)
(create-table deposits)
(init)
(coin.create-account WORK-GAS-STATION basic-guards.GUARD_SUCCESS)
(commit-tx)

(env-gasmodel "table")
(env-gaslimit 1000000000000)

(begin-tx)
(use free.cyKlone-v0-10)
; Mnemonic: human bargain engage flock unique bring board buffalo taste auction comic area
; Commitment: HeEGL8v_r6LY_GAgyt92WOyM_ETivNDcBMckxEO05W0
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE 1000.0)]}])
(deposit "alice" "HeEGL8v_r6LY_GAgyt92WOyM_ETivNDcBMckxEO05W0")
(commit-tx)


(begin-tx)
(use free.cyKlone-v0-10)
; Mnemonic: sand tone excite wire about age focus easily fossil person income habit
; Commitment: F7YrjTInreRID-_59JyBT6a2FPFXuqZlozI_o7D7uDY
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE 1000.0)]}])
(deposit "alice" "F7YrjTInreRID-_59JyBT6a2FPFXuqZlozI_o7D7uDY")
(commit-tx)


(begin-tx)
(use free.cyKlone-v0-10)
; Mnemonic: unique turn medal ozone power change ghost pudding sauce drastic code fat
; Commitment: KGPytNCSi1JSWJdlXqdOVrAv4fTe-hAa5PGNmXmatrU
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE 1000.0)]}])
(deposit "alice" "KGPytNCSi1JSWJdlXqdOVrAv4fTe-hAa5PGNmXmatrU")
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
; Mnemonic: curious become promote social concert tourist entire hole clever water kit person
; Commitment: BQyIswNTD5OaMAbIqF5JhYw8gGgY5YfB363A8_zuzts
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE 1000.0)]}])
(deposit "alice" "BQyIswNTD5OaMAbIqF5JhYw8gGgY5YfB363A8_zuzts")
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
; Mnemonic: genius capable typical gadget sunny twin side disease green frequent elder noble
; Commitment: IcYmCvv-1cVienWyjD9UpHBzi5yrWlmmC3QMWR6VqE4
(env-sigs [{'key:"alice-key", 'caps:[(coin.TRANSFER "alice" RESERVE 1000.0)]}])
(deposit "alice" "IcYmCvv-1cVienWyjD9UpHBzi5yrWlmmC3QMWR6VqE4")
(commit-tx)



(begin-tx)
(use free.cyKlone-v0-10)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(work)
(commit-tx)


(begin-tx)
(use free.cyKlone-v0-10)
(print (has-work))
(print (get-state))
(print (get-deposits-range 0 10))
(commit-tx)

(begin-tx)
(use free.cyKlone-v0-10)
(env-gas 0)
(withdraw "bob"  "L4pq5fBb-e40V9INX3QwpjywLS4aI_sNqvmX9VM8Ay8" "BanKWum1N0IdsuMGHga3fIplSdZsnMYXI4ZTaJwQqXo" "Cx0PUAiRTqrEXFcdoqfOLQ-qQpxWTNzEzNfutbfLIVMAKO5TF94TSqKMLmcwqyUUNBMXkFKKAJQAL3Op9_NkGEBCgSf3SByd6n8WAG9UX-pJ1bsSztclzKyLc3C45p31kEOOh8U2YiYhObnw4LcXMv_-gI-mr8OI5_QIwM0MvAlgIFtG_UP5nT782KaXoxcXcZufnxXdB2gM5DDKOhNcl5gI_gZqcizE2RzctXVoBZdqlbkoMKwQWrt4IzGKegslq4KDAs72NOLQYLvpsLbhlUhCK1EpPidzVqkkwF9V146sIGi6kb5YjkxTsJ2Do5RMPAHeBs2LBmpv_C6DEYp2ziQk")
(print (env-gas))
(commit-tx)


; Test local functions
(begin-tx)
(use free.cyKlone-v0-10)
(expect "Deposit rank of the second deposit" 1 (get-deposit-rank "F7YrjTInreRID-_59JyBT6a2FPFXuqZlozI_o7D7uDY"))
(expect "Deposit rank of a bad deposit" -1 (get-deposit-rank "Bad___deposit"))

(expect "Withdrawal OK" true (get-nullifier-state "L4pq5fBb-e40V9INX3QwpjywLS4aI_sNqvmX9VM8Ay8"))
(expect "Withdrawal NOK" false (get-nullifier-state "Bad__nullifer"))
(commit-tx)
